<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Log Analyzer Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
    h1 { margin-bottom: 0; }
    .sub { color: #666; margin-top: 4px; margin-bottom: 20px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    canvas { max-width: 100%; height: 380px; }
    ul { padding-left: 18px; }
    .muted { color:#666; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Log Analyzer Report</h1>
  <div class="sub">Generated at: {{ generated_at }}</div>

  <div class="cards">
    <div class="card">
      <h3>Top IPs (by requests)</h3>
      <canvas id="topIpsChart"></canvas>
    </div>
    <div class="card">
      <h3>Status Codes (distribution)</h3>
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <div class="card" style="margin-bottom:24px;">
    <h3>Timeline (requests per minute by status)</h3>
    <canvas id="timelineChart"></canvas>
    <div class="muted">Each line is a status code series.</div>
  </div>

  <div class="cards">
    <div class="card">
      <h3>Brute-force suspects</h3>
      {% if brute_force_ips %}
      <ul>{% for ip in brute_force_ips %}<li><code>{{ ip }}</code></li>{% endfor %}</ul>
      {% else %}<div class="muted">None</div>{% endif %}
    </div>
    <div class="card">
      <h3>Scanner suspects</h3>
      {% if scanner_ips %}
      <ul>{% for ip in scanner_ips %}<li><code>{{ ip }}</code></li>{% endfor %}</ul>
      {% else %}<div class="muted">None</div>{% endif %}
    </div>
    <div class="card">
      <h3>High-rate suspects</h3>
      {% if burst_ips %}
      <ul>{% for ip in burst_ips %}<li><code>{{ ip }}</code></li>{% endfor %}</ul>
      {% else %}<div class="muted">None</div>{% endif %}
    </div>
  </div>

  <div class="card">
    <h3>Suspicious Hits (sample)</h3>
    {% if suspicious_hits %}
    <table>
      <thead><tr><th>IP</th><th>Reason</th><th>Path</th></tr></thead>
      <tbody>
        {% for ip, rows in suspicious_hits.items() %}
          {% for r in rows[:8] %}
            <tr>
              <td><code>{{ ip }}</code></td>
              <td>{{ r.reason }}</td>
              <td><code>{{ r.path }}</code></td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
    <div class="muted" style="margin-top:8px;">Showing up to 8 rows per IP.</div>
    {% else %}
      <div class="muted">None</div>
    {% endif %}
  </div>

  <script>
    /* 
      These variables are injected by Jinja2 when rendering the template.
      VS Code (or other editors) may underline {{ ... }} with a red squiggly 
      because plain HTML/JS does not understand Jinja2 syntax. 
      
      This is NOT a real error â€” when you run `log_analyzer.py`, Jinja2 replaces 
      {{ top_ips_labels_json | safe }} etc. with proper JSON arrays/objects, 
      so the browser sees valid JavaScript like:
      
        const topIpsLabels = ["192.168.1.10","203.0.113.5"];
      
      In other words: the editor linter complains, but the code works fine at runtime.
     */
    const topIpsLabels = {{ top_ips_labels_json | safe }};
    const topIpsValues = {{ top_ips_values_json | safe }};
    const statusLabels = {{ status_labels_json | safe }};
    const statusValues = {{ status_values_json | safe }};
    const timelineLabels = {{ timeline_labels_json | safe }};
    const timelineSeries = {{ timeline_series_json | safe }};

    function colorAt(i){
      const colors = [
        'rgba(99, 102, 241, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(244, 63, 94, 0.8)',
        'rgba(234, 179, 8, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(139, 92, 246, 0.8)',
        'rgba(20, 184, 166, 0.8)',
      ];
      return colors[i % colors.length];
    }

    // Top IPs (bar)
    new Chart(document.getElementById('topIpsChart'), {
      type: 'bar',
      data: {
        labels: topIpsLabels,
        datasets: [{ label: 'Requests', data: topIpsValues, backgroundColor: topIpsLabels.map((_,i)=>colorAt(i)) }]
      },
      options: {
        plugins: { legend: { display: false }},
        scales: { x: { ticks: { autoSkip: false }}, y: { beginAtZero: true } }
      }
    });

    // Status Codes (doughnut)
    new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: {
        labels: statusLabels,
        datasets: [{ data: statusValues, backgroundColor: statusLabels.map((_,i)=>colorAt(i)) }]
      },
      options: {
        plugins: { legend: { position: 'bottom' }}
      }
    });

    // Timeline (line)
    const datasets = Object.keys(timelineSeries).map((status, i) => ({
      label: status,
      data: timelineSeries[status],
      borderColor: colorAt(i),
      backgroundColor: colorAt(i),
      fill: false,
      tension: 0.2,
      pointRadius: 0
    }));

    new Chart(document.getElementById('timelineChart'), {
      type: 'line',
      data: { labels: timelineLabels, datasets },
      options: {
        scales: { y: { beginAtZero: true }, x: { ticks: { maxRotation: 0, autoSkip: true } } },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  </script>
</body>
</html>
